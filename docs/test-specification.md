# 営業日報システム テスト仕様書

## 1. テスト概要

### 1.1 目的

本テスト仕様書は、営業日報システムの品質を担保するためのテスト計画・テストケースを定義する。

### 1.2 テスト方針

- テストフレームワーク: Vitest
- E2Eテスト: Playwright
- カバレッジ目標: 80%以上

### 1.3 テストレベル

| レベル | 対象 | ツール |
|--------|------|--------|
| 単体テスト | 関数、ユーティリティ、カスタムフック | Vitest |
| 結合テスト | APIエンドポイント、データベース連携 | Vitest + Prisma |
| E2Eテスト | 画面操作、ユーザーシナリオ | Playwright |

---

## 2. 単体テスト仕様

### 2.1 ユーティリティ関数

#### UT-001: 日付フォーマット関数

| テストID | テスト内容 | 入力 | 期待結果 |
|----------|------------|------|----------|
| UT-001-01 | 正常な日付変換 | `2025-01-15` | `2025年1月15日（水）` |
| UT-001-02 | 無効な日付 | `invalid` | エラーまたはnull |
| UT-001-03 | null入力 | `null` | エラーまたはnull |

#### UT-002: バリデーション関数

| テストID | テスト内容 | 入力 | 期待結果 |
|----------|------------|------|----------|
| UT-002-01 | 有効なメールアドレス | `test@example.com` | `true` |
| UT-002-02 | 無効なメールアドレス | `invalid-email` | `false` |
| UT-002-03 | 空文字 | `""` | `false` |
| UT-002-04 | 有効な電話番号 | `03-1234-5678` | `true` |
| UT-002-05 | 無効な電話番号 | `abcd` | `false` |

#### UT-003: パスワードハッシュ関数

| テストID | テスト内容 | 入力 | 期待結果 |
|----------|------------|------|----------|
| UT-003-01 | パスワードハッシュ化 | `password123` | ハッシュ値が生成される |
| UT-003-02 | ハッシュ検証（正しい） | 元パスワード + ハッシュ | `true` |
| UT-003-03 | ハッシュ検証（誤り） | 異なるパスワード + ハッシュ | `false` |

### 2.2 カスタムフック

#### UT-010: useAuth フック

| テストID | テスト内容 | 期待結果 |
|----------|------------|----------|
| UT-010-01 | 初期状態 | `user: null`, `isLoading: true` |
| UT-010-02 | ログイン成功後 | `user: {...}`, `isAuthenticated: true` |
| UT-010-03 | ログアウト後 | `user: null`, `isAuthenticated: false` |

#### UT-011: useReport フック

| テストID | テスト内容 | 期待結果 |
|----------|------------|----------|
| UT-011-01 | 日報一覧取得 | 日報配列が返される |
| UT-011-02 | 日報作成 | 新規日報が追加される |
| UT-011-03 | 日報更新 | 既存日報が更新される |

---

## 3. 結合テスト仕様（API）

### 3.1 認証API

#### IT-001: POST /api/v1/auth/login

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-001-01 | 正常ログイン | 有効なemail/password | 200, トークン返却 |
| IT-001-02 | メールアドレス誤り | 存在しないemail | 401, INVALID_CREDENTIALS |
| IT-001-03 | パスワード誤り | 誤ったpassword | 401, INVALID_CREDENTIALS |
| IT-001-04 | 無効化アカウント | is_active=falseのユーザー | 401, ACCOUNT_DISABLED |
| IT-001-05 | メールアドレス未入力 | email: "" | 422, VALIDATION_ERROR |
| IT-001-06 | パスワード未入力 | password: "" | 422, VALIDATION_ERROR |

#### IT-002: POST /api/v1/auth/logout

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-002-01 | 正常ログアウト | 有効なトークン | 200 |
| IT-002-02 | トークンなし | Authorizationヘッダーなし | 401, UNAUTHORIZED |
| IT-002-03 | 無効なトークン | 不正なトークン | 401, UNAUTHORIZED |

#### IT-003: GET /api/v1/auth/me

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-003-01 | ユーザー情報取得 | 有効なトークン | 200, ユーザー情報 |
| IT-003-02 | トークンなし | Authorizationヘッダーなし | 401 |

### 3.2 日報API

#### IT-010: GET /api/v1/reports

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-010-01 | 一覧取得（一般営業） | 一般営業でログイン | 自分の日報のみ |
| IT-010-02 | 一覧取得（上長） | 上長でログイン | 自分+部下の日報 |
| IT-010-03 | 一覧取得（管理者） | 管理者でログイン | 全員の日報 |
| IT-010-04 | 日付フィルタ | start_date, end_date指定 | 期間内の日報のみ |
| IT-010-05 | ステータスフィルタ | status=submitted | 提出済のみ |
| IT-010-06 | ページネーション | page=2, per_page=10 | 該当ページのデータ |

#### IT-011: POST /api/v1/reports

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-011-01 | 正常作成 | 必須項目すべて入力 | 201, 日報データ |
| IT-011-02 | 訪問記録複数 | visit_records 3件 | 201, 訪問記録3件含む |
| IT-011-03 | 重複日付 | 同一日付の日報が存在 | 409, DUPLICATE_REPORT |
| IT-011-04 | 報告日未入力 | report_date: null | 422, VALIDATION_ERROR |
| IT-011-05 | 訪問記録なし | visit_records: [] | 422, VALIDATION_ERROR |
| IT-011-06 | 訪問内容未入力 | content: "" | 422, VALIDATION_ERROR |
| IT-011-07 | 未来日指定 | 明日の日付 | 422, VALIDATION_ERROR |

#### IT-012: GET /api/v1/reports/{id}

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-012-01 | 自分の日報取得 | 本人の日報ID | 200, 詳細データ |
| IT-012-02 | 部下の日報取得（上長） | 部下の日報ID | 200, 詳細データ |
| IT-012-03 | 他人の日報取得（一般） | 他人の日報ID | 403, FORBIDDEN |
| IT-012-04 | 存在しないID | 無効なID | 404, NOT_FOUND |

#### IT-013: PUT /api/v1/reports/{id}

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-013-01 | 正常更新 | 有効なデータ | 200, 更新後データ |
| IT-013-02 | 訪問記録追加 | 新規visit_record | 訪問記録が追加される |
| IT-013-03 | 訪問記録削除 | 既存IDを除外 | 訪問記録が削除される |
| IT-013-04 | 他人の日報更新 | 他人の日報ID | 403, FORBIDDEN |
| IT-013-05 | ステータス変更 | draft → submitted | 200, status更新 |

#### IT-014: DELETE /api/v1/reports/{id}

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-014-01 | 正常削除 | 本人の日報ID | 200 |
| IT-014-02 | 他人の日報削除 | 他人の日報ID | 403, FORBIDDEN |
| IT-014-03 | 存在しないID | 無効なID | 404, NOT_FOUND |
| IT-014-04 | 関連データ削除 | 訪問記録・コメントあり | 関連データも削除 |

### 3.3 コメントAPI

#### IT-020: POST /api/v1/reports/{report_id}/comments

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-020-01 | 上長がコメント投稿 | 部下の日報に投稿 | 201 |
| IT-020-02 | 管理者がコメント投稿 | 任意の日報に投稿 | 201 |
| IT-020-03 | 一般営業がコメント投稿 | 他人の日報に投稿 | 403, FORBIDDEN |
| IT-020-04 | 内容未入力 | content: "" | 422, VALIDATION_ERROR |

#### IT-021: DELETE /api/v1/comments/{id}

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-021-01 | 投稿者が削除 | 自分のコメントID | 200 |
| IT-021-02 | 他人が削除 | 他人のコメントID | 403, FORBIDDEN |

### 3.4 営業マスタAPI

#### IT-030: POST /api/v1/sales-persons

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-030-01 | 管理者が正常登録 | 必須項目すべて | 201 |
| IT-030-02 | 一般営業が登録 | 必須項目すべて | 403, FORBIDDEN |
| IT-030-03 | 社員番号重複 | 既存の社員番号 | 409, DUPLICATE |
| IT-030-04 | メールアドレス重複 | 既存のメール | 409, DUPLICATE |
| IT-030-05 | パスワード短すぎ | 7文字以下 | 422, VALIDATION_ERROR |

### 3.5 顧客マスタAPI

#### IT-040: POST /api/v1/customers

| テストID | テスト内容 | リクエスト | 期待結果 |
|----------|------------|------------|----------|
| IT-040-01 | 管理者が正常登録 | 必須項目すべて | 201 |
| IT-040-02 | 一般営業が登録 | 必須項目すべて | 403, FORBIDDEN |
| IT-040-03 | 顧客コード重複 | 既存の顧客コード | 409, DUPLICATE |

---

## 4. E2Eテスト仕様

### 4.1 ログイン機能

#### E2E-001: ログインシナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-001-01 | 正常ログイン | 1. ログイン画面表示<br>2. email入力<br>3. password入力<br>4. ログインボタンクリック | ダッシュボードに遷移 |
| E2E-001-02 | ログイン失敗 | 1. 誤ったパスワード入力<br>2. ログインボタンクリック | エラーメッセージ表示 |
| E2E-001-03 | ログアウト | 1. ログアウトボタンクリック | ログイン画面に遷移 |

### 4.2 日報管理機能

#### E2E-010: 日報作成シナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-010-01 | 日報新規作成 | 1. 新規作成ボタンクリック<br>2. 報告日選択<br>3. 訪問記録追加<br>4. 顧客選択・内容入力<br>5. Problem/Plan入力<br>6. 提出ボタンクリック | 日報一覧に追加される |
| E2E-010-02 | 下書き保存 | 1. 日報入力<br>2. 下書き保存ボタンクリック | ステータス「下書き」で保存 |
| E2E-010-03 | 訪問記録複数追加 | 1. 追加ボタンを3回クリック<br>2. 各記録を入力<br>3. 提出 | 3件の訪問記録が保存される |

#### E2E-011: 日報編集シナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-011-01 | 日報編集 | 1. 日報詳細画面表示<br>2. 編集ボタンクリック<br>3. 内容修正<br>4. 保存 | 変更が反映される |
| E2E-011-02 | 訪問記録削除 | 1. 編集画面表示<br>2. 削除ボタンクリック<br>3. 保存 | 訪問記録が削除される |

#### E2E-012: 日報閲覧シナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-012-01 | 日報詳細表示 | 1. 一覧から日報選択<br>2. 詳細ボタンクリック | 詳細画面が表示される |
| E2E-012-02 | 日付フィルタ検索 | 1. 開始日・終了日入力<br>2. 検索ボタンクリック | 期間内の日報のみ表示 |

### 4.3 コメント機能

#### E2E-020: コメントシナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-020-01 | コメント投稿（上長） | 1. 部下の日報詳細表示<br>2. コメント入力<br>3. 投稿ボタンクリック | コメントが追加される |
| E2E-020-02 | コメント削除 | 1. 自分のコメントの削除ボタンクリック<br>2. 確認ダイアログでOK | コメントが削除される |

### 4.4 マスタ管理機能

#### E2E-030: 営業マスタシナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-030-01 | 営業担当者登録 | 1. 新規登録ボタンクリック<br>2. 各項目入力<br>3. 保存ボタンクリック | 一覧に追加される |
| E2E-030-02 | 営業担当者編集 | 1. 編集ボタンクリック<br>2. 内容修正<br>3. 保存 | 変更が反映される |
| E2E-030-03 | 営業担当者無効化 | 1. 編集で状態を無効に変更<br>2. 保存 | 状態が「無効」に変更 |

#### E2E-031: 顧客マスタシナリオ

| テストID | シナリオ | 手順 | 期待結果 |
|----------|----------|------|----------|
| E2E-031-01 | 顧客登録 | 1. 新規登録ボタンクリック<br>2. 各項目入力<br>3. 保存 | 一覧に追加される |
| E2E-031-02 | 顧客検索 | 1. 検索ボックスに顧客名入力<br>2. 検索ボタンクリック | 該当顧客のみ表示 |

---

## 5. 非機能テスト仕様

### 5.1 パフォーマンステスト

| テストID | テスト内容 | 条件 | 期待結果 |
|----------|------------|------|----------|
| PF-001 | ページ読み込み時間 | ダッシュボード表示 | 3秒以内 |
| PF-002 | API応答時間 | 日報一覧取得（100件） | 1秒以内 |
| PF-003 | 同時アクセス | 50ユーザー同時アクセス | エラーなし |

### 5.2 セキュリティテスト

| テストID | テスト内容 | 手順 | 期待結果 |
|----------|------------|------|----------|
| SC-001 | SQLインジェクション | 入力欄にSQLコード入力 | 無効化される |
| SC-002 | XSS攻撃 | 入力欄にスクリプトタグ入力 | エスケープされる |
| SC-003 | CSRF対策 | 外部サイトからPOST | 403エラー |
| SC-004 | 認証バイパス | トークンなしでAPI呼び出し | 401エラー |
| SC-005 | 権限昇格 | 一般営業で管理者APIアクセス | 403エラー |

### 5.3 ユーザビリティテスト

| テストID | テスト内容 | 確認項目 |
|----------|------------|----------|
| UX-001 | レスポンシブデザイン | モバイル・タブレット・PCで正常表示 |
| UX-002 | エラーメッセージ | わかりやすいエラーメッセージ表示 |
| UX-003 | ローディング表示 | 処理中はローディング表示 |
| UX-004 | フォームバリデーション | 入力時にリアルタイムバリデーション |

---

## 6. テストデータ

### 6.1 営業担当者テストデータ

| ID | 社員番号 | 氏名 | 役職 | 上長ID |
|----|----------|------|------|--------|
| 1 | EMP001 | テスト太郎 | member | 3 |
| 2 | EMP002 | テスト花子 | member | 3 |
| 3 | EMP003 | テスト課長 | manager | null |
| 4 | EMP004 | テスト管理者 | admin | null |

### 6.2 顧客テストデータ

| ID | 顧客コード | 顧客名 |
|----|------------|--------|
| 1 | C001 | テスト株式会社A |
| 2 | C002 | テスト株式会社B |
| 3 | C003 | テスト株式会社C |

### 6.3 日報テストデータ

| ID | 営業ID | 報告日 | ステータス |
|----|--------|--------|------------|
| 1 | 1 | 2025-01-15 | submitted |
| 2 | 1 | 2025-01-14 | reviewed |
| 3 | 2 | 2025-01-15 | draft |

---

## 7. テスト実行コマンド

```bash
# 単体テスト実行
npm run test

# 単体テスト（カバレッジ付き）
npm run test:coverage

# E2Eテスト実行
npm run test:e2e

# 特定ファイルのテスト実行
npm run test -- auth.test.ts

# ウォッチモードでテスト実行
npm run test:watch
```

---

## 8. テスト完了基準

| 項目 | 基準 |
|------|------|
| 単体テスト | 全テストパス、カバレッジ80%以上 |
| 結合テスト | 全テストパス |
| E2Eテスト | 主要シナリオ全パス |
| セキュリティテスト | 致命的な脆弱性なし |
| パフォーマンステスト | 目標値達成 |
